#!/bin/bash

# 获取所有 EBS 相关的 PV 和 Volume ID
kubectl get pv -o json | jq -r '.items[] | select(.spec.awsElasticBlockStore) | "\(.metadata.name) \(.spec.awsElasticBlockStore.volumeID)"' > pv_volumes.txt

# 获取所有 PVC 及其关联的 PV
kubectl get pvc --all-namespaces -o json | jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name) \(.spec.volumeName)"' > pvc_bindings.txt

# 查询每个 EBS 卷的可用区
echo "PV_NAME PVC_NAMESPACE PVC_NAME AVAILABILITY_ZONE"
while read -r pv_name volume_id; do
  availability_zone=$(aws ec2 describe-volumes --volume-ids "$volume_id" --query "Volumes[0].AvailabilityZone" --output text)
  pvc_info=$(grep "$pv_name" pvc_bindings.txt || echo "N/A N/A")
  echo "$pv_name $pvc_info $availability_zone"
done < pv_volumes.txt
